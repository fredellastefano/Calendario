<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario Interattivo con Note</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f0f0;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            min-height: 100vh;
            margin: 0;
        }

        .calendar-container {
            width: 95%;
            max-width: 1100px;
            background-color: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        h1 { 
            text-align: center; 
            color: #2c3e50; 
            margin-bottom: 10px; 
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .title-text {
            flex: 1;
            text-align: center;
        }
        
        .header-controls { 
            display: flex; 
            gap: 10px; 
        }

        .header-controls button {
            padding: 8px 15px; 
            font-size: 14px; 
            border: 1px solid #2980b9; 
            background-color: #3498db;
            color: white; 
            border-radius: 5px; 
            cursor: pointer; 
            transition: background-color 0.2s;
        }
        .header-controls button:hover { background-color: #2980b9; }
        
        .legend-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
        }
        
        .legend-row {
            display: flex;
            gap: 8px;
        }
        
        .legend-btn {
            padding: 6px 12px;
            font-size: 13px;
            font-weight: bold;
            border: 1px solid #333;
            border-radius: 4px;
            cursor: default;
            user-select: none;
        }
        
        .modify-btn {
            padding: 6px 12px;
            font-size: 11px;
            font-weight: bold;
            border: 1px solid #666;
            border-radius: 4px;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
        }
        
        .modify-btn.locked {
            background-color: #95a5a6;
            color: #fff;
        }
        
        .modify-btn.unlocked {
            background-color: #e74c3c;
            color: #fff;
        }
        
        .modify-btn:hover {
            opacity: 0.8;
        }
        
        .csv-controls {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .csv-btn {
            padding: 6px 12px;
            font-size: 12px;
            font-weight: bold;
            border: 1px solid #333;
            border-radius: 4px;
            cursor: pointer;
            transition: opacity 0.2s;
            color: #333;
        }
        
        .csv-btn:hover {
            opacity: 0.8;
        }
        
        .download-btn {
            background-color: #f1c40f;
        }
        
        .upload-btn {
            background-color: #e74c3c;
            color: #fff;
        }
        
        .legend-yellow {
            background-color: #f1c40f;
            color: #333;
        }
        
        .legend-red {
            background-color: #e74c3c;
            color: #fff;
        }
        
        .io-controls { 
            display: none;
        }

        .io-controls button {
            padding: 8px 15px; font-size: 14px; border: 1px solid #2980b9; background-color: #3498db;
            color: white; border-radius: 5px; cursor: pointer; transition: background-color 0.2s;
        }
        .io-controls button:hover { background-color: #2980b9; }

        .controls { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 15px; 
            margin-bottom: 25px; 
        }

        .controls select { padding: 8px 12px; font-size: 16px; border: 1px solid #ccc; border-radius: 6px; }

        .controls button {
            padding: 6px 14px; font-size: 20px; font-weight: bold; border: 1px solid #ccc;
            border-radius: 6px; background-color: #f8f9fa; cursor: pointer;
            transition: background-color 0.2s; line-height: 1.5;
        }
        .controls button:hover { background-color: #e9ecef; }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }

        .day-header { font-weight: bold; text-align: center; padding: 10px 0; background-color: #ecf0f1; border-radius: 4px; }

        .day-cell {
            position: relative;
            height: 0;
            padding-bottom: 76.5%;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            overflow: hidden;
        }

        .day-cell:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }

        .day-number { position: absolute; top: 5px; left: 5px; font-size: 14px; font-weight: bold; z-index: 1; }

        .day-note {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: pre-wrap;
            word-break: break-word;
            width: 80%;
            max-height: 60%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .day-options {
            position: absolute;
            bottom: 3px;
            right: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            color: rgba(0,0,0,0.4);
            z-index: 2;
        }
        .day-options:hover { color: rgba(0,0,0,0.8); }

        .day-yellow { background-color: #f1c40f; color: #333; }
        .day-red { background-color: #e74c3c; color: #fff; }

        #debug-status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }

        .status-success {
            background-color: #2ecc71;
            color: #fff;
        }

        .status-warning {
            background-color: #f1c40f;
            color: #333;
        }

        .status-error {
            background-color: #e74c3c;
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="calendar-container">
        <h1>
            <div style="width: 140px;"></div>
            <div class="title-text">Calendario Interattivo con Note</div>
            <div class="legend-controls">
                <div class="legend-row">
                    <span class="legend-btn legend-red">Chiara</span>
                    <span class="legend-btn legend-yellow">Stefano</span>
                </div>
                <button id="modify-btn" class="modify-btn locked">Abilita modifica calendario</button>
                <div class="csv-controls">
                    <button id="download-btn" class="csv-btn download-btn">Scarica CSV</button>
                    <button id="upload-btn" class="csv-btn upload-btn">Carica CSV</button>
                </div>
            </div>
            <input type="file" id="upload-input" accept=".csv" style="display: none;">
        </h1>
        <div class="controls">
            <button id="prev-month-btn" title="Mese precedente">&larr;</button>
            <select id="month-select"></select>
            <select id="year-select"></select>
            <button id="next-month-btn" title="Mese successivo">&rarr;</button>
        </div>
        <div class="calendar-grid" id="day-headers">
             <div class="day-header">Lunedì</div><div class="day-header">Martedì</div><div class="day-header">Mercoledì</div>
             <div class="day-header">Giovedì</div><div class="day-header">Venerdì</div><div class="day-header">Sabato</div>
             <div class="day-header">Domenica</div>
        </div>
        <div class="calendar-grid" id="calendar-body"></div>
        <div id="debug-status">Stato connessione: In attesa...</div>
    </div>

    <script>
        // --- CONFIGURAZIONE JSONBIN.IO (MODIFICA CON LE TUE CHIAVI) ---
        const BIN_ID = 'TUA_BIN_ID'; 
        const SECRET_KEY = 'TUA_SECRET_KEY'; 

        let modifiedDaysDB = {};
        let isModificationLocked = true;
        
        const debugStatusEl = document.getElementById('debug-status');

        function setStatus(message, type = 'default') {
            debugStatusEl.textContent = `Stato connessione: ${message}`;
            debugStatusEl.className = '';
            if (type === 'success') debugStatusEl.classList.add('status-success');
            if (type === 'warning') debugStatusEl.classList.add('status-warning');
            if (type === 'error') debugStatusEl.classList.add('status-error');
        }

        // --- GESTIONE DATI REMOTA ---
        function loadModifications() {
            setStatus('Caricamento dati...');
            return fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
                method: 'GET',
                headers: {
                    'X-Master-Key': SECRET_KEY
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Errore di rete: ${response.status} ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data && data.record && data.record.modifiche) {
                    modifiedDaysDB = data.record.modifiche;
                    setStatus('Dati caricati con successo da JSONBin.io.', 'success');
                } else {
                    modifiedDaysDB = {};
                    setStatus('Dati non trovati o struttura non valida. Inizializzazione.', 'warning');
                }
            })
            .catch(error => {
                setStatus(`Errore nel caricamento dei dati: ${error.message}. Controlla BIN_ID e Secret Key.`, 'error');
                console.error('Errore nel caricamento dei dati:', error);
            });
        }

        function saveModifications() {
            setStatus('Salvataggio dati...');
            fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Master-Key': SECRET_KEY
                },
                body: JSON.stringify({ modifiche: modifiedDaysDB })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Errore di rete: ${response.status} ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                setStatus('Dati salvati con successo su JSONBin.io.', 'success');
            })
            .catch(error => {
                setStatus(`Errore nel salvataggio: ${error.message}. Controlla i permessi della Secret Key.`, 'error');
                console.error('Errore nel salvataggio dei dati:', error);
            });
        }

        // --- ELEMENTI DOM ---
        const monthSelect = document.getElementById('month-select');
        const yearSelect = document.getElementById('year-select');
        const calendarBody = document.getElementById('calendar-body');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const downloadBtn = document.getElementById('download-btn');
        const uploadBtn = document.getElementById('upload-btn');
        const uploadInput = document.getElementById('upload-input');
        const modifyBtn = document.getElementById('modify-btn');
        const months = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"];

        // --- INIZIALIZZAZIONE ---
        document.addEventListener('DOMContentLoaded', () => {
            populateSelects(new Date().getMonth(), new Date().getFullYear());

            monthSelect.addEventListener('change', renderCalendar);
            yearSelect.addEventListener('change', renderCalendar);
            prevMonthBtn.addEventListener('click', goToPrevMonth);
            nextMonthBtn.addEventListener('click', goToNextMonth);
            downloadBtn.addEventListener('click', downloadCSV);
            uploadBtn.addEventListener('click', () => uploadInput.click());
            uploadInput.addEventListener('change', uploadCSV);
            modifyBtn.addEventListener('click', toggleModificationLock);
            
            loadModifications().finally(() => {
                renderCalendar();
                updateModifyButtonAppearance();
            });
        });

        function populateSelects(currentMonth, currentYear) {
            months.forEach((month, index) => monthSelect.add(new Option(month, index)));
            for (let i = currentYear - 10; i <= currentYear + 10; i++) yearSelect.add(new Option(i, i));
            monthSelect.value = currentMonth;
            yearSelect.value = currentYear;
        }

        // --- LOGICA CALENDARIO ---
        function renderCalendar() {
            const year = parseInt(yearSelect.value);
            const month = parseInt(monthSelect.value);
            calendarBody.innerHTML = '';
            const firstDayOfMonth = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            let startingDay = (firstDayOfMonth.getDay() === 0) ? 6 : firstDayOfMonth.getDay() - 1;
            for (let i = 0; i < startingDay; i++) calendarBody.appendChild(document.createElement('div'));

            for (let day = 1; day <= daysInMonth; day++) {
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dbEntry = modifiedDaysDB[dateKey];
                const currentDate = new Date(year, month, day);
                
                const dayCell = document.createElement('div');
                dayCell.className = 'day-cell';
                if (!isModificationLocked) {
                    dayCell.addEventListener('click', () => toggleDayColor(dateKey));
                }

                const dayNumber = document.createElement('span');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;
                
                const dayNote = document.createElement('div');
                dayNote.className = 'day-note';
                
                const dayOptions = document.createElement('span');
                dayOptions.className = 'day-options';
                dayOptions.innerHTML = '&hellip;';
                dayOptions.title = 'Aggiungi/Modifica nota';
                dayOptions.addEventListener('click', (event) => {
                    event.stopPropagation();
                    handleNoteEdit(dateKey);
                });

                dayCell.append(dayNumber, dayNote, dayOptions);

                const defaultColor = getDefaultColor(currentDate);
                const isModified = dbEntry?.modified ?? false;
                const finalColor = isModified ? (defaultColor === 'yellow' ? 'red' : 'yellow') : defaultColor;
                dayCell.classList.add(`day-${finalColor}`);
                if (dbEntry?.note) {
                    dayNote.textContent = dbEntry.note;
                }

                calendarBody.appendChild(dayCell);
            }
        }

        function getDefaultColor(date) {
            const dayOfWeek = date.getDay();
            if (dayOfWeek === 1 || dayOfWeek === 2) return 'yellow';
            if (dayOfWeek === 3 || dayOfWeek === 4) return 'red';
            const weekNumber = getWeekNumber(date);
            return (weekNumber % 2 === 0) ? 'red' : 'yellow';
        }

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        // --- GESTIONE BLOCCO MODIFICHE ---
        function toggleModificationLock() {
            isModificationLocked = !isModificationLocked;
            updateModifyButtonAppearance();
            renderCalendar();
        }

        function updateModifyButtonAppearance() {
            if (isModificationLocked) {
                modifyBtn.classList.remove('unlocked');
                modifyBtn.classList.add('locked');
            } else {
                modifyBtn.classList.remove('locked');
                modifyBtn.classList.add('unlocked');
            }
        }

        // --- GESTIONE STATO GIORNI (Colore e Note) ---
        function cleanupEntry(dateKey) {
            const entry = modifiedDaysDB[dateKey];
            if (entry && !entry.modified && !entry.note) {
                delete modifiedDaysDB[dateKey];
            }
        }

        function toggleDayColor(dateKey) {
            if (isModificationLocked) return;
            
            if (!modifiedDaysDB[dateKey]) {
                modifiedDaysDB[dateKey] = { modified: true, note: "" };
            } else {
                modifiedDaysDB[dateKey].modified = !modifiedDaysDB[dateKey].modified;
            }
            cleanupEntry(dateKey);
            saveModifications();
            renderCalendar();
        }

        function handleNoteEdit(dateKey) {
            const currentNote = modifiedDaysDB[dateKey]?.note || "";
            const newNote = prompt("Aggiungi o modifica la nota:", currentNote);

            if (newNote !== null) {
                const trimmedNote = newNote.trim();
                if (!modifiedDaysDB[dateKey]) {
                    modifiedDaysDB[dateKey] = { modified: false, note: trimmedNote };
                } else {
                    modifiedDaysDB[dateKey].note = trimmedNote;
                }
                cleanupEntry(dateKey);
                saveModifications();
                renderCalendar();
            }
        }
        
        // --- GESTIONE NAVIGAZIONE ---
        function goToPrevMonth() {
            let y = parseInt(yearSelect.value), m = parseInt(monthSelect.value);
            m--; if (m < 0) { m = 11; y--; }
            updateAndRender(y, m);
        }
        function goToNextMonth() {
            let y = parseInt(yearSelect.value), m = parseInt(monthSelect.value);
            m++; if (m > 11) { m = 0; y++; }
            updateAndRender(y, m);
        }
        function updateAndRender(year, month) {
            const minYear = parseInt(yearSelect.options[0].value);
            const maxYear = parseInt(yearSelect.options[yearSelect.options.length - 1].value);
            if (year >= minYear && year <= maxYear) {
                yearSelect.value = year; monthSelect.value = month;
                renderCalendar();
            }
        }

        // --- GESTIONE CSV ---
        function downloadCSV() {
            const modifiedDates = Object.keys(modifiedDaysDB).sort();
            if (modifiedDates.length === 0) return alert("Nessun dato da salvare.");

            let csvContent = "date,is_modified,note\r\n";
            modifiedDates.forEach(dateKey => {
                const entry = modifiedDaysDB[dateKey];
                const isModified = entry.modified ? '1' : '0';
                let note = entry.note || '';
                const safeNote = `"${note.replace(/"/g, '""')}"`;
                csvContent += `${dateKey},${isModified},${safeNote}\r\n`;
            });

            const link = document.createElement("a");
            link.setAttribute("href", "data:text/csv;charset=utf-8," + encodeURIComponent(csvContent));
            link.setAttribute("download", "calendario_note.csv");
            link.click();
        }

        function uploadCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const rows = text.split('\n').map(r => r.trim()).filter(r => r);

                if (rows.length < 1 || !rows[0].toLowerCase().startsWith('date,is_modified,note')) {
                    return alert("File CSV non valido. L'intestazione deve essere 'date,is_modified,note'.");
                }
                
                const newModifiedDays = {};
                try {
                    for (let i = 1; i < rows.length; i++) {
                        const [date, isModified, ...noteParts] = rows[i].split(',');
                        let note = noteParts.join(',');

                        if (/^\d{4}-\d{2}-\d{2}$/.test(date)) {
                            if (note.startsWith('"') && note.endsWith('"')) {
                               note = note.slice(1, -1).replace(/""/g, '"');
                            }
                            newModifiedDays[date] = {
                                modified: isModified === '1',
                                note: note
                            };
                        }
                    }
                    modifiedDaysDB = newModifiedDays;
                    saveModifications();
                    renderCalendar();
                    alert(`Stato ripristinato con successo da ${Object.keys(newModifiedDays).length} date.`);
                } catch (error) {
                    alert("Errore durante la lettura del file CSV. Assicurati che sia formattato correttamente.");
                }
            };
            reader.readAsText(file);
            uploadInput.value = '';
        }
    </script>
</body>
</html>